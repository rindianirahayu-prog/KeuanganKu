<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KeuanganKu V2.15 - Auto Translate Fixed</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --hue: 250; 
            --primary: hsl(var(--hue), 80%, 60%);
            --primary-light: hsl(var(--hue), 80%, 90%);
            --secondary: #10b981; 
            --danger: #ff6b6b; 
            --warning: #ffd93d;
            
            --bg-body: #f4f6f8;
            --bg-card: #ffffff;
            --text-main: #2d3436;
            --text-muted: #636e72;
            --border: #dfe6e9;
            --radius: 24px;
            
            --font-main: 'Quicksand', sans-serif;
            --shadow: 0 8px 20px rgba(0,0,0,0.05);
            --bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        body.dark {
            --bg-body: #2d3436; --bg-card: #353b48;
            --text-main: #dfe6e9; --text-muted: #b2bec3; --border: #636e72;
        }

        .bg-dots { background-image: radial-gradient(var(--primary-light) 2px, transparent 2px); background-size: 20px 20px; }
        .bg-gradient { background: linear-gradient(135deg, var(--bg-body) 0%, var(--primary-light) 100%); }
        .bg-custom { background-size: cover; background-position: center; background-attachment: fixed; position: relative; }
        .bg-custom::before { content:''; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.85); z-index:-1; backdrop-filter: blur(5px); }
        body.dark .bg-custom::before { background: rgba(0,0,0,0.8); }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: var(--font-main); background-color: var(--bg-body); color: var(--text-main); 
            margin: 0; padding-top: 140px; padding-bottom: 90px; transition: color .3s, background-color .3s;
            min-height: 100vh;
        }

        /* HEADER & NAV */
        .header-wrapper {
            position: fixed; top: 15px; left: 50%; transform: translateX(-50%); 
            width: 95%; max-width: 1200px; z-index: 999;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px);
            border-radius: var(--radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.5);
            padding: 10px 20px;
        }
        body.dark .header-wrapper { background: rgba(53, 59, 72, 0.9); border-color: #636e72; }

        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        h1 { margin: 0; font-size: 1.4rem; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; }

        .nav-tabs { display: flex; overflow-x: auto; gap: 5px; scrollbar-width: none; justify-content: flex-start; }
        .nav-item {
            padding: 8px 16px; font-weight: 700; color: var(--text-muted); cursor: pointer; 
            border-radius: 20px; transition: .3s var(--bounce); font-size: 0.9rem; white-space: nowrap;
        }
        .nav-item.active { background: var(--primary); color: white; transform: scale(1.05); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        /* UI COMPONENTS */
        .container { max-width: 800px; margin: 0 auto; padding: 0 20px; }
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 25px; }
        
        /* NEW CLASS: GRID FORM (Untuk perbaikan input mobile) */
        .grid-form { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
            gap: 10px; 
        }

        .card { 
            background: var(--bg-card); padding: 25px; border-radius: var(--radius); 
            border: 2px solid transparent; box-shadow: var(--shadow); transition: .3s;
            position: relative; overflow: hidden;
            margin-bottom: 10px;
        }
        h3 { margin: 0 0 15px 0; font-weight: 800; color: var(--text-main); display: flex; align-items: center; gap: 10px; }

        button { 
            padding: 12px 20px; border-radius: 16px; border: none; font-weight: 700; cursor: pointer; 
            background: var(--primary); color: white; transition: .2s var(--bounce); font-size: 0.95rem; font-family: var(--font-main);
        }
        button:hover { transform: scale(1.05); filter: brightness(1.1); }
        .btn-outline { background: transparent; border: 2px solid var(--border); color: var(--text-muted); }
        .btn-danger { background: var(--danger); } .btn-success { background: var(--secondary); }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; border-radius: 12px; }
        .btn-icon { width: 40px; height: 40px; padding: 0; display: inline-flex; align-items: center; justify-content: center; border-radius: 12px; }
        .btn-block { width: 100%; display: block; }
        
        input, select { 
            width: 100%; padding: 12px 15px; border-radius: 16px; border: 2px solid var(--border); 
            background: var(--bg-body); color: var(--text-main); outline: none; margin-bottom: 10px; 
            font-family: var(--font-main); font-weight: 600; transition: .3s;
        }
        input:focus { border-color: var(--primary); background: var(--bg-card); }

        .view-section { display: none; animation: popUp 0.4s var(--bounce); }
        .view-section.active { display: block; }
        @keyframes popUp { from { opacity: 0; transform: scale(0.95) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .text-xl { font-size: 1.6rem; font-weight: 800; }
        .text-sm { font-size: 0.85rem; color: var(--text-muted); font-weight: 600; }
        .badge { padding: 5px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; }
        .color-dot { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: .2s; }
        .color-dot:hover { transform: scale(1.2); }
        
        .table-container { overflow-x: auto; border-radius: 16px; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        th, td { padding: 15px; text-align: left; }
        th { background: var(--bg-body); color: var(--text-muted); font-weight: 700; }
        tr:not(:last-child) td { border-bottom: 1px solid var(--border); }

        #toast-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px; }
        .toast { padding: 15px; border-radius: 20px; color: white; font-weight: 700; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 15px; animation: popUp 0.3s; }
        
        .mascot-box { 
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white; padding: 20px; border-radius: var(--radius); margin-bottom: 25px;
            text-align: center; position: relative; overflow: hidden;
        }
        .mascot-emoji { font-size: 3rem; margin-bottom: 5px; display: block; animation: float 3s infinite ease-in-out; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        .chart-wrapper { position: relative; height: 250px; width: 100%; }
        #fileInput, #bgInput, #avatarInput { display: none; }

        .profile-header { text-align: center; margin-bottom: 20px; }
        .avatar-wrapper { position: relative; width: 120px; height: 120px; margin: 0 auto 15px; cursor: pointer; transition: transform .2s; }
        .avatar-wrapper:active { transform: scale(0.95); }
        .avatar-circle { width: 100%; height: 100%; background: #dfe6e9; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 4px solid var(--primary); background-size: cover; background-position: center; overflow: hidden; box-shadow: var(--shadow); }
        .avatar-circle img { width:100%; height:100%; object-fit:cover; }
        .avatar-circle svg { width: 60%; height: 60%; fill: #a4b0be; }
        .edit-overlay { position: absolute; bottom: 5px; right: 5px; background: var(--primary); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; font-size: 0.9rem; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        
        .filter-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .analysis-row { display: flex; justify-content: space-between; border-bottom: 1px solid var(--border); padding: 10px 0; }
        .analysis-row:last-child { border-bottom: none; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-overlay.active { display: flex; animation: fadeIn 0.2s; }
        .modal-card { background: var(--bg-card); width: 90%; max-width: 400px; padding: 25px; border-radius: var(--radius); box-shadow: 0 10px 30px rgba(0,0,0,0.3); animation: popUp 0.3s; }

        /* ANALYTICS STYLES */
        .toggle-group { background: var(--bg-body); padding: 5px; border-radius: 16px; display: flex; gap: 5px; margin-bottom: 15px; border: 1px solid var(--border); }
        .toggle-btn { flex: 1; padding: 10px; text-align: center; cursor: pointer; border-radius: 12px; font-weight: 700; font-size: 0.9rem; color: var(--text-muted); transition: .3s; }
        .toggle-btn.active { background: var(--bg-card); color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        .detail-item { padding: 10px 0; border-bottom: 1px solid var(--border); }
        .detail-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-weight: 700; padding: 5px 0; }
        .detail-sub { padding-left: 15px; margin-top: 5px; display: none; border-left: 2px solid var(--border); }
        .detail-sub.open { display: block; animation: slideDown 0.2s; }
        .sub-row { display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-muted); padding: 3px 0; }
        @keyframes slideDown { from {opacity:0; transform:translateY(-5px)} to {opacity:1; transform:translateY(0)} }
    </style>
</head>
<body class="bg-dots">

<div class="header-wrapper">
    <div class="header-top">
        <h1>ğŸ‘› KeuanganKu</h1>
        <div style="display:flex; gap:8px">
            <button onclick="downloadExcel()" class="btn-outline btn-sm" title="Download Excel">ğŸ“¥</button>
            <button onclick="toggleThemeMode()" class="btn-outline btn-sm" title="Dark Mode">ğŸŒ“</button>
        </div>
    </div>
    <div class="nav-tabs">
        <div class="nav-item active" id="tab-dashboard" onclick="switchView('dashboard')" data-i18n="nav_home">ğŸ  Home</div>
        <div class="nav-item" id="tab-analytics" onclick="switchView('analytics')"data-i18n="nav_analytics">ğŸ“Š Analisis</div>
        <div class="nav-item" id="tab-wallets" onclick="switchView('wallets')" data-i18n="nav_wallet">ğŸ‘œ Dompet</div>
        <div class="nav-item" id="tab-transactions" onclick="switchView('transactions')" data-i18n="nav_record">ğŸ“ Catat</div>
        <div class="nav-item" id="tab-debts" onclick="switchView('debts')" data-i18n="nav_debt">ğŸ“’ Hutang</div>
        <div class="nav-item" id="tab-subs" onclick="switchView('subs')" data-i18n="nav_subs">ğŸ”„ Langganan</div>
        <div class="nav-item" id="tab-account" onclick="switchView('account')" data-i18n="nav_account">ğŸ‘¤ Akun</div>
    </div>
</div>

<div class="container">

    <div id="view-dashboard" class="view-section active">
        <div class="mascot-box">
            <span id="mascotEmoji" class="mascot-emoji">ğŸ‘‹</span>
            <h2 id="mascotTitle" style="margin:0; font-size:1.2rem;">Halo, Bos!</h2>
            <p id="mascotText" style="margin:5px 0 0 0; opacity:0.9; font-size:0.9rem;">Siap mengatur uang hari ini?</p>
        </div>

        <div class="grid-4">
            <div class="card">
                <div class="text-sm" data-i18n="total_asset">Total Aset</div>
                <div id="saldoDisplay" class="text-xl" style="color:var(--primary)">0</div>
            </div>
            <div class="card">
                <div class="text-sm" data-i18n="this_month">Bulan Ini</div>
                <div style="margin-top:5px">
                    <div class="flex-between"><span class="text-sm" data-i18n="income">Masuk</span> <span id="incDisplay" style="color:var(--secondary)">0</span></div>
                    <div class="flex-between"><span class="text-sm" data-i18n="expense">Keluar</span> <span id="expDisplay" style="color:var(--danger)">0</span></div>
                </div>
            </div>
            <div class="card" style="border-bottom: 4px solid var(--warning);">
                <div class="flex-between">
                    <div class="text-sm" data-i18n="runway">Nafas Darurat ğŸŒ¬ï¸</div>
                    <button onclick="openEmergencyModal()" class="btn-sm" title="Isi Dana Darurat" style="background:var(--warning); color:#333; width:30px; height:30px; padding:0; border-radius:50%; display:flex; align-items:center; justify-content:center;">+</button>
                </div>
                <div id="runwayDisplay" class="text-xl" style="color:var(--warning)">0 Bulan</div>
                <small id="avgExpDisplay" class="text-sm">Avg: 0</small>
            </div>

            <div class="card" style="border-bottom: 4px solid #0ea5e9;">
                <div class="text-sm" data-i18n="dream_fund">Tabungan Impian âœ¨</div>
                <div id="totalFundsDisplay" class="text-xl" style="color:#0ea5e9">0</div>
            </div>
        </div>

        <div class="card">
            <h3 data-i18n="analysis_title">ğŸ“ˆ Analisis Keuangan</h3>
            <div id="analysisContainer">
            </div>
        </div>

        <div class="card">
            <h3 data-i18n="annual_chart">ğŸ“Š Grafik Tahunan</h3>
            <div class="chart-wrapper"><canvas id="chartAnnual"></canvas></div>
        </div>

        <div class="card">
            <h3 data-i18n="expense_portion">ğŸ• Porsi Pengeluaran</h3>
            <div class="filter-row">
                <select id="filterMonth" onchange="renderCharts()" style="flex:1"></select>
                <select id="filterYear" onchange="renderCharts()" style="flex:1"></select>
            </div>
            <div class="grid-2">
                <div style="text-align:center"><small data-i18n="selected_month">Bulan Terpilih</small><div class="chart-wrapper"><canvas id="chartMonthly"></canvas></div></div>
                <div style="text-align:center"><small data-i18n="selected_year">Tahun Terpilih</small><div class="chart-wrapper"><canvas id="chartYearly"></canvas></div></div>
            </div>
        </div>
        
        <div class="card" style="border: 2px dashed var(--border);">
            <div class="flex-between">
                <h3 style="color:#0ea5e9" data-i18n="dream_fund">âœ¨ Tabungan Impian</h3>
                <button onclick="toggleFundForm()" class="btn-sm btn-outline" data-i18n="btn_add">Tambah</button>
            </div>
            <div id="fundForm" style="display:none; margin-top:15px;">
                <input type="text" id="fundName" data-i18n-ph="ph_name" placeholder="Mau beli apa?">
                <input type="number" id="fundTarget" data-i18n-ph="ph_target" placeholder="Target Harga">
                <button onclick="addFund()" class="btn-success btn-block" data-i18n="btn_save">Simpan Target</button>
            </div>
            <div id="fundsList" class="grid-2" style="margin-top:20px"></div>
        </div>
    </div>

    <div id="view-analytics" class="view-section">
        <div class="card">
            <h3 data-i18n="ana_detail_title">ğŸ“ˆ Analisis Detail</h3>
            <div class="toggle-group">
                <div class="toggle-btn active" id="modeMonth" onclick="setAnalyticsMode('month')" data-i18n="ana_monthly">ğŸ—“ï¸ Per Bulan</div>
                <div class="toggle-btn" id="modeRange" onclick="setAnalyticsMode('range')" data-i18n="ana_range">ğŸ“… Rentang Tanggal</div>
            </div>
            
            <div id="filterMonthArea">
                <div class="filter-row">
                    <select id="anaMonth" style="flex:1"></select>
                    <select id="anaYear" style="flex:1"></select>
                </div>
            </div>
            <div id="filterRangeArea" style="display:none;">
                <div class="filter-row">
                    <input type="date" id="anaStart">
                    <input type="date" id="anaEnd">
                </div>
            </div>
            
            <button onclick="calculateAnalytics()" class="btn-block btn-success" data-i18n="btn_show_ana">ğŸ” Tampilkan Analisis</button>
        </div>

        <div id="analyticsResult"></div>
    </div>

    <div id="view-wallets" class="view-section">
        <div class="card" style="margin-bottom:20px; border-left:5px solid #f59e0b;">
            <h3 data-i18n="transfer_title">â‡„ Transfer Antar Dompet</h3>
            <div class="grid-2">
                <div>
                    <label class="text-sm" data-i18n="from">Dari</label>
                    <select id="trfSource"></select>
                </div>
                <div>
                    <label class="text-sm" data-i18n="to">Ke</label>
                    <select id="trfTarget"></select>
                </div>
            </div>
            <input type="number" id="trfAmount" data-i18n-ph="ph_amount" placeholder="Nominal">
            <button onclick="processTransfer()" class="btn-block" style="background:#f59e0b" data-i18n="btn_transfer">Transfer Sekarang</button>
        </div>

        <div class="card">
            <h3 data-i18n="manage_wallet">ğŸ‘œ Kelola Dompet</h3>
            <p class="text-sm" style="margin-bottom:15px" data-i18n="wallet_desc">Buat akun untuk Tunai, ATM, atau E-Wallet.</p>
            <div class="grid-2">
                <div>
                    <label class="text-sm" data-i18n="wallet_name">Nama Dompet</label>
                    <input type="text" id="wName" data-i18n-ph="ph_wallet_name" placeholder="Contoh: BCA / Tunai">
                    <label class="text-sm" data-i18n="type">Tipe</label>
                    <select id="wIcon">
                        <option value="ğŸ’µ">ğŸ’µ Cash</option>
                        <option value="ğŸ’³">ğŸ’³ Bank/Card</option>
                        <option value="ğŸ“±">ğŸ“± E-Wallet</option>
                        <option value="ğŸ–">ğŸ– Savings</option>
                    </select>
                </div>
                <div>
                    <label class="text-sm" data-i18n="initial_balance">Saldo Awal</label>
                    <input type="number" id="wInit" placeholder="0">
                    <button onclick="addWallet()" class="btn-block" data-i18n="btn_create_wallet">Buat Dompet</button>
                </div>
            </div>
        </div>
        <div id="walletsList" class="grid-2"></div>
    </div>

    <div id="view-transactions" class="view-section">
        <div class="card">
            <h3 data-i18n="record_trans">ğŸ“ Catat Transaksi</h3>
            <div class="grid-2" style="margin-bottom:0">
                <div>
                    <label class="text-sm" data-i18n="lbl_detail">Detail</label>
                    <div style="display:flex; gap:10px">
                        <input type="date" id="tDate">
                        <select id="tType"><option value="expense" data-i18n="expense">ğŸ’¸ Pengeluaran</option><option value="income" data-i18n="income">ğŸ’° Pemasukan</option></select>
                    </div>
                    <label class="text-sm" data-i18n="wallet">Dompet / Akun</label>
                    <select id="tWallet"></select> 
                    <input type="number" id="tAmount" data-i18n-ph="ph_amount" placeholder="Nominal">
                    <input type="text" id="tNote" data-i18n-ph="ph_note" placeholder="Catatan (mis: Makan Siang)">
                </div>
                <div>
                    <label class="text-sm" data-i18n="category">Kategori</label>
                    <select id="tCat" onchange="updateSub('tCat','tSub')"><option value="">Pilih Kategori...</option></select>
                    <select id="tSub"><option value="">-</option></select>
                    <button onclick="addTransaction()" class="btn-block" style="margin-top:10px" data-i18n="btn_save">Simpan</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h3 data-i18n="target_budget">ğŸ¯ Target Budget</h3>
             <div class="grid-form">
                <input type="month" id="bMonth">
                <input type="number" id="bAmount" data-i18n-ph="ph_limit" placeholder="Limit">
                <select id="bCat" onchange="updateSub('bCat','bSub')"><option>Kategori</option></select>
                <select id="bSub"><option>-</option></select>
            </div>
            <button onclick="setBudget()" class="btn-outline btn-block" style="margin-top:5px" data-i18n="btn_set_alarm">Pasang Alarm Budget ğŸš¨</button>
            <div id="budgetList" style="margin-top:15px; max-height:200px; overflow-y:auto"></div>
        </div>

        <div class="card">
            <div class="flex-between">
                <h3 data-i18n="history">ğŸ” Riwayat</h3>
                <button onclick="downloadPDF()" class="btn-success btn-sm" style="display:flex; align-items:center; gap:5px">ğŸ“„ PDF</button>
            </div>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap:10px; margin-bottom:15px; margin-top:10px;">
                <input type="text" id="searchKeyword" data-i18n-ph="ph_search" placeholder="Cari..." onkeyup="renderHistory()" style="margin:0">
                <input type="date" id="searchDateStart" onchange="renderHistory()" style="margin:0">
                <input type="date" id="searchDateEnd" onchange="renderHistory()" style="margin:0">
                <select id="searchType" onchange="renderHistory()" style="margin:0">
                    <option value="all" data-i18n="all">Semua</option>
                    <option value="income" data-i18n="income">Masuk</option>
                    <option value="expense" data-i18n="expense">Keluar</option>
                </select>
            </div>
            <div class="table-container">
                <table id="historyTable">
                    <thead><tr><th data-i18n="date">Tgl</th><th data-i18n="info">Info</th><th data-i18n="amount">Jumlah</th><th></th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="view-debts" class="view-section">
        <div class="card">
            <h3 data-i18n="debt_book">ğŸ“’ Buku Hutang</h3>
            <div class="grid-2">
                <div>
                    <input type="text" id="dName" data-i18n-ph="ph_who" placeholder="Siapa?">
                    <select id="dType">
                        <option value="receivable" data-i18n="receivable">Dia Pinjam Saya (Piutang) ğŸŸ¢</option>
                        <option value="payable" data-i18n="payable">Saya Pinjam Dia (Hutang) ğŸ”´</option>
                    </select>
                    <input type="number" id="dAmount" data-i18n-ph="ph_amount" placeholder="Berapa?">
                    
                    <label class="text-sm" style="margin-top:5px; display:block" data-i18n="use_wallet">Gunakan Dompet:</label>
                    <select id="dWallet"></select>
                    
                    <button onclick="addDebt()" class="btn-block" style="margin-top:10px" data-i18n="btn_record">Catat</button>
                </div>
                <div style="text-align:center; display:flex; flex-direction:column; justify-content:center; background:var(--bg-body); border-radius:16px; padding:15px;">
                    <div class="text-sm" data-i18n="total_receivable">Total Piutang (Uangmu di luar)</div>
                    <div id="totalReceivable" class="text-xl" style="color:var(--secondary); margin-bottom:10px">0</div>
                    <div class="text-sm" data-i18n="total_payable">Total Hutang (Harus dibayar)</div>
                    <div id="totalPayable" class="text-xl" style="color:var(--danger)">0</div>
                </div>
            </div>
        </div>
        <div id="debtsList" class="grid-2"></div>
    </div>

    <div id="view-subs" class="view-section">
        <div class="card" style="text-align:center">
            <h3 data-i18n="subs_routine">ğŸ”„ Langganan Rutin</h3>
            <p class="text-sm" style="margin-bottom:15px" data-i18n="subs_desc">Jangan sampai lupa bayar Netflix/Wifi!</p>
            <div style="display:flex; gap:10px; max-width:500px; margin:0 auto;">
                <input type="text" id="sName" data-i18n-ph="ph_name" placeholder="Nama">
                <input type="number" id="sAmount" data-i18n-ph="ph_cost" placeholder="Biaya">
                <select id="sCycle" style="width:100px"><option value="1" data-i18n="month">Bulan</option><option value="12" data-i18n="year">Tahun</option></select>
            </div>
            <button onclick="addSub()" class="btn-success" style="margin-top:10px; width:100%; max-width:500px;" data-i18n="btn_add">Tambah</button>
        </div>
        <div id="subsList" class="grid-4"></div>
    </div>

    <div id="view-account" class="view-section">
        <div class="card">
            <div class="profile-header">
                <div class="avatar-wrapper" onclick="document.getElementById('avatarInput').click()">
                    <div class="avatar-circle" id="profileAvatar">
                        <svg viewBox="0 0 24 24">
                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                    </div>
                    <div class="edit-overlay">ğŸ“·</div>
                </div>
                <input type="file" id="avatarInput" accept="image/*" onchange="handleAvatarFile(this)">
                
                <h3 style="justify-content:center; margin-bottom:5px" id="profileNameDisplay">User</h3>
            </div>
            <label class="text-sm" data-i18n="nickname">Nama Panggilan</label>
            <div style="display:flex; gap:10px">
                <input type="text" id="inputProfileName" data-i18n-ph="ph_your_name" placeholder="Nama Anda">
                <button onclick="updateProfile()" class="btn-success btn-sm" style="width:auto" data-i18n="btn_save">Simpan</button>
            </div>
        </div>

        <div class="card">
            <h3 data-i18n="personalization">ğŸŒ Personalisasi & Bahasa</h3>
            
            <label class="text-sm" style="margin-top:10px; display:block" data-i18n="language">Bahasa / Language</label>
            <select id="langSelect" onchange="changeLanguage(this.value)">
                <option value="id">ğŸ‡®ğŸ‡© Indonesia</option>
                <option value="en">ğŸ‡¬ğŸ‡§ English</option>
<option value="ch">ğŸ‡¨ğŸ‡³ Mandarin</option>
            </select>

            <label class="text-sm" style="margin-top:10px; display:block" data-i18n="currency">Mata Uang / Currency</label>
            <div style="display:flex; gap:10px">
                <select id="currencySymbol" style="flex:2">
                    <option value="Rp">Rp (Rupiah)</option>
                    <option value="$">$ (Dollar)</option>
                    <option value="â‚¬">â‚¬ (Euro)</option>
                    <option value="Â¥">Â¥ (Yen)</option>
                    <option value="Â£">Â£ (Pound)</option>
                    <option value="RM">RM (Ringgit)</option>
                    <option value="S$">S$ (Dolar Singapura)</option>
                    <option value="â‚©">â‚© (Won)</option>
                </select>
                <select id="currencyLocale" style="flex:1">
                    <option value="id-ID">1.000.000 (ID)</option>
                    <option value="en-US">1,000,000 (US)</option>
                </select>
                <button onclick="updateCurrency()" class="btn-success btn-sm" style="width:auto">OK</button>
            </div>

            <label class="text-sm" style="margin-top:10px; display:block" data-i18n="custom_bg">Background Kostum</label>
            <div style="display:flex; gap:10px">
                <button onclick="document.getElementById('bgInput').click()" class="btn-outline btn-block" data-i18n="btn_upload">ğŸ–¼ï¸ Upload Foto</button>
                <button onclick="resetBg()" class="btn-danger btn-icon" title="Reset">âŒ</button>
            </div>
            <input type="file" id="bgInput" accept="image/*" onchange="handleBgUpload(this)">
            <p class="text-sm" style="font-size:0.75rem; margin-top:5px; color:var(--text-muted)" data-i18n="txt_max_size">Max 1 MB. (Disimpan di browser)</p>
        </div>

        <div class="card">
            <h3 data-i18n="theme">ğŸ¨ Tema Warna</h3>
            <div style="display:flex; gap:15px; margin-top:10px; flex-wrap:wrap;">
                <div class="color-dot" style="background:#6366f1" onclick="updateHue(250)"></div>
                <div class="color-dot" style="background:#ec4899" onclick="updateHue(330)"></div>
                <div class="color-dot" style="background:#10b981" onclick="updateHue(160)"></div>
                <div class="color-dot" style="background:#f59e0b" onclick="updateHue(35)"></div>
                <div class="color-dot" style="background:#3b82f6" onclick="updateHue(210)"></div>
                <div class="color-dot" style="background:#8b5cf6" onclick="updateHue(270)"></div>
                <input type="range" min="0" max="360" oninput="updateHue(this.value)" style="flex:1">
            </div>
            <div style="display:flex; gap:10px; margin-top:15px">
                <button onclick="updateBg('bg-dots')" class="btn-outline btn-sm" style="flex:1" data-i18n="theme_dots">Polkadot</button>
                <button onclick="updateBg('bg-gradient')" class="btn-outline btn-sm" style="flex:1" data-i18n="theme_grad">Gradasi</button>
                <button onclick="updateBg('')" class="btn-outline btn-sm" style="flex:1" data-i18n="theme_plain">Polos</button>
            </div>
        </div>

        <div class="card">
            <h3 data-i18n="data_manage">âš™ï¸ Kelola Data</h3>
            <div class="grid-2">
                <div>
                    <label class="text-sm" data-i18n="add_cat">Tambah Kategori</label>
                    <div style="display:flex; gap:5px"><input type="text" id="newCatName"><button onclick="addNewCategory()" class="btn-icon btn-success">+</button></div>
                    <label class="text-sm" style="color:var(--danger)" data-i18n="del_cat">Hapus Kategori</label>
                    <div style="display:flex; gap:5px"><select id="delCatSelect"></select><button onclick="deleteCategory()" class="btn-icon btn-danger">ğŸ—‘ï¸</button></div>
                </div>
                <div>
                    <label class="text-sm" data-i18n="add_sub">Tambah Sub</label>
                    <div style="display:flex; gap:5px"><select id="parentCatSelect"></select><input type="text" id="newSubName"><button onclick="addNewSubCategory()" class="btn-icon btn-success">+</button></div>
                    <label class="text-sm" style="color:var(--danger); margin-top:10px; display:block" data-i18n="del_sub">Hapus Sub Kategori</label>
                    <div style="display:flex; gap:5px">
                        <select id="delSubParent" onchange="updateSub('delSubParent','delSubSelect')"></select>
                        <select id="delSubSelect"></select>
                        <button onclick="deleteSubCategory()" class="btn-icon btn-danger">ğŸ—‘ï¸</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h3 data-i18n="backup">ğŸ›¡ï¸ Backup Data</h3>
            <div class="grid-2">
                <button onclick="backupData()" class="btn-outline" data-i18n="save">ğŸ’¾ Simpan (.json)</button>
                <button onclick="document.getElementById('fileInput').click()" class="btn-outline" data-i18n="open">ğŸ“‚ Buka (.json)</button>
            </div>
            <input type="file" id="fileInput" accept=".json" onchange="restoreData(this)">
        </div>
    </div>

</div>

<div id="editModal" class="modal-overlay">
    <div class="modal-card">
        <h3 data-i18n="modal_edit">âœï¸ Edit Transaksi</h3>
        <input type="hidden" id="editId">
        <label class="text-sm" data-i18n="lbl_date">Tanggal</label>
        <input type="date" id="editDate">
        <label class="text-sm" data-i18n="lbl_type">Tipe</label>
        <select id="editType">
            <option value="expense" data-i18n="expense">ğŸ’¸ Pengeluaran</option>
            <option value="income" data-i18n="income">ğŸ’° Pemasukan</option>
        </select>
        <label class="text-sm" data-i18n="wallet">Dompet</label>
        <select id="editWallet"></select>
        <label class="text-sm" data-i18n="lbl_amount">Nominal</label>
        <input type="number" id="editAmount">
        <label class="text-sm" data-i18n="category">Kategori</label>
        <select id="editCat" onchange="updateSub('editCat','editSub')"></select>
        <select id="editSub"></select>
        <label class="text-sm" data-i18n="lbl_note">Catatan</label>
        <input type="text" id="editNote">
        <div style="display:flex; gap:10px; margin-top:15px">
            <button onclick="saveEditTransaction()" class="btn-success btn-block" data-i18n="btn_save">Simpan</button>
            <button onclick="closeEditModal()" class="btn-danger btn-block" data-i18n="btn_cancel">Batal</button>
        </div>
    </div>
</div>

<div id="nabungModal" class="modal-overlay">
    <div class="modal-card">
        <h3 id="nabungTitle" data-i18n="modal_nabung">â• Isi Tabungan</h3>
        <input type="hidden" id="nabungFundId">
        <label class="text-sm" data-i18n="source_wallet">Dari Dompet</label>
        <select id="nabungSourceWallet"></select>
        <label class="text-sm" data-i18n="storage_loc">Ke Dompet (Penyimpanan)</label>
        <select id="nabungTargetWallet"></select>
        <label class="text-sm" data-i18n="lbl_amount">Nominal</label>
        <input type="number" id="nabungAmount" data-i18n-ph="ph_amount" placeholder="Jumlah">
        <div style="display:flex; gap:10px; margin-top:15px">
            <button onclick="processNabung()" class="btn-success btn-block" data-i18n="btn_tabung">Tabung!</button>
            <button onclick="document.getElementById('nabungModal').classList.remove('active')" class="btn-danger btn-block" data-i18n="btn_cancel">Batal</button>
        </div>
    </div>
</div>

<div id="emergencyModal" class="modal-overlay">
    <div class="modal-card">
        <h3 data-i18n="modal_emergency">ğŸŒ¬ï¸ Isi Dana Darurat</h3>
        <label class="text-sm" data-i18n="source_wallet">Dari Dompet</label>
        <select id="emgSourceWallet"></select>
        <label class="text-sm" data-i18n="storage_loc">Simpan di Dompet</label>
        <select id="emgTargetWallet"></select>
        <label class="text-sm" data-i18n="lbl_amount">Nominal</label>
        <input type="number" id="emgAmount" data-i18n-ph="ph_amount" placeholder="Jumlah">
        <div style="display:flex; gap:10px; margin-top:15px">
            <button onclick="processEmergencyFund()" class="btn-success btn-block" data-i18n="btn_fill_emergency">Simpan!</button>
            <button onclick="document.getElementById('emergencyModal').classList.remove('active')" class="btn-danger btn-block" data-i18n="btn_cancel">Batal</button>
        </div>
    </div>
</div>

<div id="toast-container"></div>

<script>
// --- DICTIONARY & I18N ---
const translations = {
    id: {
        // --- NAV & GENERAL ---
        nav_home: "ğŸ  Home", nav_analytics:"ğŸ“Š Analisis", nav_wallet: "ğŸ‘œ Dompet", nav_record: "ğŸ“ Catat", nav_debt: "ğŸ“’ Hutang", nav_subs: "ğŸ”„ Langganan", nav_account: "ğŸ‘¤ Akun",
        total_asset: "Total Aset", this_month: "Bulan Ini", income: "Masuk", expense: "Keluar", runway: "Nafas Darurat ğŸŒ¬ï¸", dream_fund: "Tabungan Impian âœ¨",
        analysis_title: "ğŸ“ˆ Analisis Keuangan", annual_chart: "ğŸ“Š Grafik Tahunan", expense_portion: "ğŸ• Porsi Pengeluaran",
        selected_month: "Bulan Terpilih", selected_year: "Tahun Terpilih", btn_add: "Tambah", btn_save: "Simpan", btn_cancel: "Batal",
        
        // --- WALLET ---
        manage_wallet: "ğŸ‘œ Kelola Dompet", wallet_desc: "Buat akun Tunai, ATM, atau E-Wallet.", wallet_name: "Nama Dompet", type: "Tipe", initial_balance: "Saldo Awal", btn_create_wallet: "Buat Dompet",
        transfer_title: "â‡„ Transfer Antar Dompet", from: "Dari", to: "Ke", btn_transfer: "Transfer Sekarang", source_wallet: "Dari Dompet", target_wallet: "Ke Dompet",
        
        // --- TRANSACTIONS ---
        record_trans: "ğŸ“ Catat Transaksi", wallet: "Dompet / Akun", category: "Kategori", target_budget: "ğŸ¯ Target Budget", btn_set_alarm: "Pasang Alarm Budget ğŸš¨",
        history: "ğŸ” Riwayat", all: "Semua", date: "Tgl", info: "Info", amount: "Jumlah", note: "Catatan",
        
        // --- DEBT & SUBS ---
        debt_book: "ğŸ“’ Buku Hutang", receivable: "Dia Pinjam Saya (Piutang) ğŸŸ¢", payable: "Saya Pinjam Dia (Hutang) ğŸ”´", btn_record: "Catat", total_receivable: "Total Piutang (Uangmu di luar)", total_payable: "Total Hutang (Harus dibayar)",
        subs_routine: "ğŸ”„ Langganan Rutin", subs_desc: "Jangan sampai lupa bayar Netflix/Wifi!", month: "Bulan", year: "Tahun",
        
        // --- SETTINGS ---
        nickname: "Nama Panggilan", personalization: "ğŸŒ Personalisasi & Bahasa", language: "Bahasa / Language", currency: "Mata Uang / Currency", custom_bg: "Background Kostum", theme: "ğŸ¨ Tema Warna",
        data_manage: "âš™ï¸ Kelola Data", add_cat: "Tambah Kategori", del_cat: "Hapus Kategori", add_sub: "Tambah Sub", del_sub: "Hapus Sub Kategori", backup: "ğŸ›¡ï¸ Backup Data", save: "ğŸ’¾ Simpan (.json)", open: "ğŸ“‚ Buka (.json)",
        
        // --- MASCOT & ALERTS ---
        mascot_hi: "Halo", mascot_warn: "Hati-hati", mascot_cool: "Mode Sultan", mascot_danger: "Gawat",
        msg_balance: "Siap mengatur uang hari ini?", msg_warn: "Dana darurat menipis.", msg_cool: "Keuangan sangat sehat.", msg_danger: "Saldo minus, stop jajan!",
        
        months_arr: ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"],
        avg_monthly: "Pengeluaran Wajib / Bulan", current_ef: "Dana Darurat Saat Ini", target: "Target", progress: "Progress", status: "Status",
        status_risk: "ğŸŸ¥ Risiko Tinggi", status_safe: "ğŸŸ© Aman", status_ideal: "ğŸŸ¦ Ideal", status_ok: "ğŸŸ§ Cukup",
        lbl_date: "Tanggal", lbl_type: "Tipe", lbl_amount: "Nominal", lbl_note: "Catatan", lbl_category: "Kategori", lbl_detail: "Detail",
        btn_tabung: "Tabung!", btn_fill_emergency: "Simpan!",
        modal_edit: "âœï¸ Edit Transaksi", modal_nabung: "â• Isi Tabungan", modal_emergency: "ğŸŒ¬ï¸ Isi Dana Darurat",
        storage_loc: "Ke Dompet (Penyimpanan)", avg_txt: "Rata-rata",
        balance_txt: "Saldo:", short_receivable: "PIUTANG", short_payable: "HUTANG", status_paid: "LUNAS",
        
        ana_detail_title: "ğŸ“ˆ Analisis Detail", ana_monthly: "ğŸ—“ï¸ Per Bulan", ana_range: "ğŸ“… Rentang Tanggal", btn_show_ana: "ğŸ” Tampilkan Analisis",
        theme_dots: "Polkadot", theme_grad: "Gradasi", theme_plain: "Polos",
        ph_name: "Nama", ph_cost: "Biaya", ph_amount: "Berapa/Jumlah", ph_note: "Catatan (mis: Makan)", ph_who: "Siapa?", ph_wallet_name: "Contoh: BCA / Tunai", ph_target: "Target Harga", ph_your_name: "Nama Anda", ph_search: "Cari...", ph_limit: "Limit Budget",
        opt_select: "-- Pilih --", btn_upload: "ğŸ–¼ï¸ Upload Foto", txt_max_size: "Max 1 MB. (Disimpan di browser)",
        opt_sub_placeholder: "Sub Kategori...",

        // --- NEW KEYS FOR DYNAMIC TRANSLATION (FIXED) ---
        use_wallet: "Gunakan Dompet:",
        pay_btn: "Bayar",
        del_btn: "Hapus",
        pay_confirm: "Bayar",
        settle_prompt: "Pilih Dompet untuk Pelunasan:\n",
        settle_saved: "Lunas & Saldo Diupdate!",
        debt_saved: "Hutang dicatat!",
        trans_success: "Transfer Berhasil!",
        wallet_invalid: "Dompet tidak valid!",
        data_incomplete: "Data tidak lengkap!",
        mark_paid: "âœ… Tandai Lunas",
        mark_ok: "âœ… OK"
    },
    en: {
        nav_home: "ğŸ  Home", nav_analytics:"ğŸ“Š Analytics", nav_wallet: "ğŸ‘œ Wallets", nav_record: "ğŸ“ Record", nav_debt: "ğŸ“’ Debts", nav_subs: "ğŸ”„ Subs", nav_account: "ğŸ‘¤ Account",
        total_asset: "Total Assets", this_month: "This Month", income: "Income", expense: "Expense", runway: "Runway (Emergency) ğŸŒ¬ï¸", dream_fund: "Dream Funds âœ¨",
        analysis_title: "ğŸ“ˆ Financial Analysis", annual_chart: "ğŸ“Š Annual Chart", expense_portion: "ğŸ• Spending Portion",
        selected_month: "Selected Month", selected_year: "Selected Year", btn_add: "Add", btn_save: "Save", btn_cancel: "Cancel",
        
        manage_wallet: "ğŸ‘œ Manage Wallets", wallet_desc: "Create Cash, Bank, or E-Wallet accounts.", wallet_name: "Wallet Name", type: "Type", initial_balance: "Initial Balance", btn_create_wallet: "Create Wallet",
        transfer_title: "â‡„ Transfer Funds", from: "From", to: "To", btn_transfer: "Transfer Now", source_wallet: "From Wallet", target_wallet: "To Wallet",
        
        record_trans: "ğŸ“ Record Transaction", wallet: "Wallet / Account", category: "Category", target_budget: "ğŸ¯ Budget Target", btn_set_alarm: "Set Budget Alarm ğŸš¨",
        history: "ğŸ” History", all: "All", date: "Date", info: "Info", amount: "Amount", note: "Note",
        
        debt_book: "ğŸ“’ Debt Book", receivable: "They Owe Me (Receivable) ğŸŸ¢", payable: "I Owe Them (Payable) ğŸ”´", btn_record: "Record", total_receivable: "Total Receivables", total_payable: "Total Payables",
        subs_routine: "ğŸ”„ Subscriptions", subs_desc: "Don't forget Netflix/Wifi bills!", month: "Month", year: "Year",
        
        nickname: "Nickname", personalization: "ğŸŒ Personalization & Language", language: "Bahasa / Language", currency: "Mata Uang / Currency", custom_bg: "Custom Background", theme: "ğŸ¨ Color Theme",
        data_manage: "âš™ï¸ Manage Data", add_cat: "Add Category", del_cat: "Delete Category", add_sub: "Add Sub-Category", del_sub: "Delete Sub-Category", backup: "ğŸ›¡ï¸ Backup Data", save: "ğŸ’¾ Save (.json)", open: "ğŸ“‚ Open (.json)",
        
        mascot_hi: "Hello", mascot_warn: "Careful", mascot_cool: "Sultan Mode", mascot_danger: "Alert",
        msg_balance: "Ready to manage money?", msg_warn: "Emergency funds running low.", msg_cool: "Financial health is great.", msg_danger: "Balance negative, stop spending!",
        
        months_arr: ["January","February","March","April","May","June","July","August","September","October","November","December"],
        avg_monthly: "Mandatory Exp / Month", current_ef: "Current Emergency Fund", target: "Target", progress: "Progress", status: "Status",
        status_risk: "ğŸŸ¥ High Risk", status_safe: "ğŸŸ© Safe", status_ideal: "ğŸŸ¦ Ideal", status_ok: "ğŸŸ§ Good Enough",
        lbl_date: "Date", lbl_type: "Type", lbl_amount: "Amount", lbl_note: "Note", lbl_category: "Category", lbl_detail: "Detail",
        btn_tabung: "Save It!", btn_fill_emergency: "Save Fund!",
        modal_edit: "âœï¸ Edit Transaction", modal_nabung: "â• Add to Fund", modal_emergency: "ğŸŒ¬ï¸ Fill Emergency Fund",
        storage_loc: "To Wallet (Storage)", avg_txt: "Avg",
        balance_txt: "Balance:", short_receivable: "LENT", short_payable: "DEBT", status_paid: "PAID",

        ana_detail_title: "ğŸ“ˆ Detailed Analysis", ana_monthly: "ğŸ—“ï¸ Monthly", ana_range: "ğŸ“… Date Range", btn_show_ana: "ğŸ” Show Analytics",
        theme_dots: "Polka", theme_grad: "Gradient", theme_plain: "Plain",
        ph_name: "Name", ph_cost: "Cost", ph_amount: "Amount", ph_note: "Note (ex: Lunch)", ph_who: "Who?", ph_wallet_name: "Ex: Bank / Cash", ph_target: "Target Price", ph_your_name: "Your Name", ph_search: "Search...", ph_limit: "Budget Limit",
        opt_select: "-- Select --", btn_upload: "ğŸ–¼ï¸ Upload Photo", txt_max_size: "Max 1 MB. (Saved locally)",
        opt_sub_placeholder: "Sub-Category...",

        // --- NEW KEYS FOR DYNAMIC TRANSLATION (FIXED) ---
        use_wallet: "Use Wallet:",
        pay_btn: "Pay",
        del_btn: "Delete",
        pay_confirm: "Pay",
        settle_prompt: "Select Wallet for Settlement:\n",
        settle_saved: "Settled & Balance Updated!",
        debt_saved: "Debt Recorded!",
        trans_success: "Transfer Success!",
        wallet_invalid: "Invalid Wallet!",
        data_incomplete: "Incomplete Data!",
        mark_paid: "âœ… Mark Paid",
        mark_ok: "âœ… OK"
    },
    ch: {
        nav_home: "ğŸ  é¦–é¡µ", nav_analytics:"ğŸ“Š åˆ†æ", nav_wallet: "ğŸ‘œ é’±åŒ…", nav_record: "ğŸ“ è®°è´¦", nav_debt: "ğŸ“’ å€ºåŠ¡", nav_subs: "ğŸ”„ è®¢é˜…", nav_account: "ğŸ‘¤ æˆ‘çš„",
        total_asset: "æ€»èµ„äº§", this_month: "æœ¬æœˆ", income: "æ”¶å…¥", expense: "æ”¯å‡º", runway: "å¤‡ç”¨é‡‘ (åº”æ€¥)ğŸŒ¬ï¸", dream_fund: "æ¢¦æƒ³åŸºé‡‘ âœ¨",
        analysis_title: "ğŸ“ˆ è´¢åŠ¡åˆ†æ", annual_chart: "ğŸ“Š å¹´åº¦å›¾è¡¨", expense_portion: "ğŸ• æ”¯å‡ºå æ¯”",
        selected_month: "æ‰€é€‰æœˆä»½", selected_year: "æ‰€é€‰å¹´ä»½", btn_add: "æ·»åŠ ", btn_save: "ä¿å­˜", btn_cancel: "å–æ¶ˆ",
        
        manage_wallet: "ğŸ‘œ é’±åŒ…ç®¡ç†", wallet_desc: "åˆ›å»ºç°é‡‘ã€é“¶è¡Œæˆ–ç”µå­é’±åŒ…è´¦æˆ·ã€‚", wallet_name: "è´¦æˆ·åç§°", type: "ç±»å‹", initial_balance: "åˆå§‹ä½™é¢", btn_create_wallet: "åˆ›å»ºé’±åŒ…",
        transfer_title: "â‡„ èµ„é‡‘è½¬è´¦", from: "ä»", to: "åˆ°", btn_transfer: "ç«‹å³è½¬è´¦", source_wallet: "ä»é’±åŒ…", target_wallet: "åˆ°é’±åŒ…",
        
        record_trans: "ğŸ“ è®°å½•äº¤æ˜“", wallet: "è´¦æˆ· / é’±åŒ…", category: "ç±»åˆ«", target_budget: "ğŸ¯ é¢„ç®—ç›®æ ‡", btn_set_alarm: "è®¾ç½®é¢„ç®—æé†’ğŸš¨",
        history: "ğŸ” å†å²è®°å½•", all: "å…¨éƒ¨", date: "æ—¥æœŸ", info: "å¤‡æ³¨", amount: "é‡‘é¢", note: "å¤‡æ³¨",
        
        debt_book: "ğŸ“’ è´¦æœ¬", receivable: "å€Ÿå‡ºæ¬¾ (åº”æ”¶) ğŸŸ¢", payable: "æ¬ æ¬¾ (åº”ä»˜) ğŸ”´", btn_record: "è®°å½•", total_receivable: "æ€»åº”æ”¶æ¬¾", total_payable: "æ€»åº”ä»˜æ¬¾",
        subs_routine: "ğŸ”„ å®šæœŸè®¢é˜…", subs_desc: "åˆ«å¿˜äº†è§†é¢‘ä¼šå‘˜æˆ–å®½å¸¦è´¹ç”¨!", month: "æœˆ", year: "å¹´",
        
        nickname: "æ˜µç§°", personalization: "ğŸŒ ä¸ªæ€§åŒ–ä¸è¯­è¨€", language: "Bahasa / Language", currency: "Mata Uang / Currency", custom_bg: "è‡ªå®šä¹‰èƒŒæ™¯", theme: "ğŸ¨ è‰²å½©ä¸»é¢˜",
        data_manage: "âš™ï¸ æ•°æ®ç®¡ç†", add_cat: "æ·»åŠ ç±»åˆ«", del_cat: "åˆ é™¤ç±»åˆ«", add_sub: "æ·»åŠ å­ç±»åˆ«", del_sub: "åˆ é™¤å­ç±»åˆ«", backup: "ğŸ›¡ï¸ å¤‡ä»½æ•°æ®", save: "ğŸ’¾ ä¿å­˜ (.json)", open: "ğŸ“‚ æ‰“å¼€ (.json)",
        
        mascot_hi: "ä½ å¥½", mascot_warn: "æ³¨æ„", mascot_cool: "åœŸè±ªæ¨¡å¼", mascot_danger: "è­¦å‘Š",
        msg_balance: "å‡†å¤‡å¥½ç†è´¢äº†å—?", msg_warn: "åº”ç§¯æè¿›æ­¥ç»„ã€‚", msg_cool: "è´¢åŠ¡çŠ¶å†µéå¸¸å¥åº·ã€‚", msg_danger: "ä½™é¢ä¸ºè´Ÿï¼Œåœæ­¢æ¶ˆè´¹ï¼",
        
        months_arr: ["ä¸€æœˆ","äºŒæœˆ","ä¸‰æœˆ","å››æœˆ","äº”æœˆ","å…­æœˆ","ä¸ƒæœˆ","å…«æœˆ","ä¹æœˆ","åæœˆ","åä¸€æœˆ","åäºŒæœˆ"],
        avg_monthly: "æ¯æœˆå¿…é¡»æ”¯å‡º", current_ef: "å½“å‰å¤‡ç”¨é‡‘", target: "ç›®æ ‡", progress: "è¿›åº¦", status: "çŠ¶æ€",
        status_risk: "ğŸŸ¥ é«˜é£é™©", status_safe: "ğŸŸ© å®‰å…¨", status_ideal: "ğŸŸ¦ ç†æƒ³", status_ok: "ğŸŸ§ è¿˜è¡Œ",
        lbl_date: "æ—¥æœŸ", lbl_type: "ç±»å‹", lbl_amount: "é‡‘é¢", lbl_note: "å¤‡æ³¨", lbl_category: "åˆ†ç±»", lbl_detail: "è¯¦æƒ…",
        btn_tabung: "å­˜å…¥!", btn_fill_emergency: "å­˜å…¥å¤‡ç”¨é‡‘!",
        modal_edit: "âœï¸ ç¼–è¾‘äº¤æ˜“", modal_nabung: "â• å­˜é’±", modal_emergency: "ğŸŒ¬ï¸ è¡¥å……å¤‡ç”¨é‡‘",
        storage_loc: "å­˜å…¥è´¦æˆ·", avg_txt: "å¹³å‡",
        balance_txt: "ä½™é¢:", short_receivable: "å€Ÿå‡º", short_payable: "æ¬ æ¬¾", status_paid: "å·²ä»˜",

        ana_detail_title: "ğŸ“ˆ è¯¦ç»†åˆ†æ", ana_monthly: "ğŸ—“ï¸ æŒ‰æœˆ", ana_range: "ğŸ“… æ—¥æœŸèŒƒå›´", btn_show_ana: "ğŸ” æ˜¾ç¤ºåˆ†æ",
        theme_dots: "æ³¢ç‚¹", theme_grad: "æ¸å˜", theme_plain: "çº¯è‰²",
        ph_name: "åç§°", ph_cost: "è´¹ç”¨", ph_amount: "é‡‘é¢", ph_note: "å¤‡æ³¨ (å¦‚:åˆé¤)", ph_who: "è°?", ph_wallet_name: "ä¾‹å¦‚: é“¶è¡Œ / ç°é‡‘", ph_target: "ç›®æ ‡é‡‘é¢", ph_your_name: "ä½ çš„åå­—", ph_search: "æœç´¢...", ph_limit: "é¢„ç®—é™é¢",
        opt_select: "-- é€‰æ‹© --", btn_upload: "ğŸ–¼ï¸ ä¸Šä¼ å›¾ç‰‡", txt_max_size: "æœ€å¤§ 1MB (æœ¬åœ°ä¿å­˜)",
        opt_sub_placeholder: "å­ç±»åˆ«...",

        // --- NEW KEYS FOR DYNAMIC TRANSLATION (FIXED) ---
        use_wallet: "ä½¿ç”¨é’±åŒ…:",
        pay_btn: "æ”¯ä»˜",
        del_btn: "åˆ é™¤",
        pay_confirm: "æ”¯ä»˜",
        settle_prompt: "é€‰æ‹©ç»“ç®—é’±åŒ…:\n",
        settle_saved: "å·²ç»“æ¸…å¹¶æ›´æ–°ä½™é¢!",
        debt_saved: "å€ºåŠ¡å·²è®°å½•!",
        trans_success: "è½¬è´¦æˆåŠŸ!",
        wallet_invalid: "é’±åŒ…æ— æ•ˆ!",
        data_incomplete: "æ•°æ®ä¸å®Œæ•´!",
        mark_paid: "âœ… æ ‡è®°ä¸ºå·²ä»˜",
        mark_ok: "âœ… å®Œæˆ"
    }
};

// Global Config
let appConfig = JSON.parse(localStorage.getItem('appConfig')) || { lang: 'id', curSymbol: 'Rp', curLocale: 'id-ID' };
let currentLang = appConfig.lang;

function t(key) { return translations[currentLang][key] || key; }

function updateDOMText() {
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if(translations[currentLang][key]) el.innerText = translations[currentLang][key];
    });
    document.querySelectorAll('[data-i18n-ph]').forEach(el => {
        const key = el.getAttribute('data-i18n-ph');
        if(translations[currentLang][key]) el.placeholder = translations[currentLang][key];
    });
}

function changeLanguage(lang) {
    currentLang = lang; appConfig.lang = lang; localStorage.setItem('appConfig', JSON.stringify(appConfig));
    updateDOMText(); renderDashboard(); renderHistory(); renderDebts(); renderSubs(); refreshTransferDropdowns(); populateChartFilters();
    refreshCats(); 
    updateSub('tCat','tSub'); updateSub('bCat','bSub');
}

// --- CURRENCY LOGIC ---
function fmtMoney(amount) { return `${appConfig.curSymbol} ${Number(amount).toLocaleString(appConfig.curLocale)}`; }
function updateCurrency() {
    const sym = document.getElementById('currencySymbol').value; const loc = document.getElementById('currencyLocale').value;
    appConfig.curSymbol = sym; appConfig.curLocale = loc; localStorage.setItem('appConfig', JSON.stringify(appConfig)); location.reload();
}

// --- CUSTOM BACKGROUND ---
function handleBgUpload(input) {
    const file = input.files[0];
    if(file) {
        if(file.size > 1024 * 1024) return alert("File terlalu besar! Max 1MB.");
        const reader = new FileReader();
        reader.onload = function(e) {
            try { localStorage.setItem('customBgImage', e.target.result); applyBg(e.target.result); } catch(err) { alert("Quota penyimpanan penuh."); }
        };
        reader.readAsDataURL(file);
    }
}
function applyBg(dataUrl) {
    if(!dataUrl) { document.body.style.backgroundImage = ''; document.body.classList.remove('bg-custom'); return; }
    document.body.classList.remove('bg-dots', 'bg-gradient'); document.body.classList.add('bg-custom'); document.body.style.backgroundImage = `url(${dataUrl})`;
}
function resetBg() { localStorage.removeItem('customBgImage'); document.body.style.backgroundImage = ''; document.body.classList.remove('bg-custom'); document.body.classList.add('bg-dots'); updateBg('bg-dots'); }

// --- UTILS ---
function showToast(msg, type='success') {
    const box = document.getElementById('toast-container'); const el = document.createElement('div'); el.className = `toast`;
    el.style.background = type==='success' ? 'var(--secondary)' : 'var(--danger)'; el.innerHTML = `<span>${type==='success'?'ğŸ‰':'ğŸ˜¤'}</span> ${msg}`;
    box.appendChild(el); setTimeout(() => { el.style.opacity='0'; setTimeout(()=>el.remove(),300) }, 3000);
}
function switchView(viewId) {
    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
    document.getElementById('view-'+viewId).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-'+viewId).classList.add('active');
    if(viewId === 'dashboard') renderDashboard();
    if(viewId === 'transactions') renderHistory();
    if(viewId === 'debts') renderDebts();
    if(viewId === 'subs') renderSubs();
    if(viewId === 'wallets') { renderWallets(); refreshTransferDropdowns(); }
    if(viewId === 'account') { renderAccount(); }
}
if (typeof ChartDataLabels !== 'undefined') Chart.register(ChartDataLabels);

// --- THEME ---
function updateHue(val) { document.documentElement.style.setProperty('--hue', val); localStorage.setItem('themeHue', val); }
function updateBg(cls) { 
    if(localStorage.getItem('customBgImage')) return; 
    document.body.className = cls; 
    if(localStorage.getItem('themeMode') === 'dark') document.body.classList.add('dark'); 
    localStorage.setItem('themeBg', cls); 
}
function toggleThemeMode() { document.body.classList.toggle('dark'); localStorage.setItem('themeMode', document.body.classList.contains('dark') ? 'dark' : 'light'); }
function loadTheme() {
    const h = localStorage.getItem('themeHue'); if(h) updateHue(h);
    const customBg = localStorage.getItem('customBgImage');
    if(customBg) applyBg(customBg); else { const b = localStorage.getItem('themeBg'); if(b) document.body.className = b; }
    if(localStorage.getItem('themeMode')==='dark') document.body.classList.add('dark');
}

function updateMascot(balance, runway) {
    const emo = document.getElementById('mascotEmoji'); const tit = document.getElementById('mascotTitle'); const txt = document.getElementById('mascotText');
    const name = userProfile.name || "Bos"; 
    if(balance < 0) { emo.innerText = "ğŸ˜°"; tit.innerText = `${t('mascot_danger')}, ${name}!`; txt.innerText = t('msg_danger'); }
    else if (runway < 1) { emo.innerText = "ğŸ˜°"; tit.innerText = `${t('mascot_warn')}, ${name}!`; txt.innerText = t('msg_warn'); }
    else if (runway < 3) { emo.innerText = "ğŸ¤”"; tit.innerText = `${t('mascot_warn')}, ${name}`; txt.innerText = t('msg_balance'); }
    else if (runway >= 6) { emo.innerText = "ğŸ˜"; tit.innerText = `${t('mascot_cool')}, ${name}!`; txt.innerText = t('msg_cool'); }
    else { emo.innerText = "ğŸ‘‹"; tit.innerText = `${t('mascot_hi')}, ${name}!`; txt.innerText = t('msg_balance'); }
}

// --- DATA INITIALIZATION ---
const defaultCats = { 'Kebutuhan': ['Makan','Transport','Cicilan','Listrik/Air','Belanja'], 'Keinginan': ['Jajan','Hobi','Hiburan'], 'Tabungan': ['Dana Darurat','Investasi'], 'Gaji': ['Utama','Bonus'], 'Hutang/Piutang': ['Bayar Hutang', 'Terima Piutang'], 'Transfer': ['Masuk', 'Keluar'] };
let categories = JSON.parse(localStorage.getItem('myCategories')) || defaultCats;
if(!categories['Transfer']) categories['Transfer'] = ['Masuk', 'Keluar'];

let transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
let budgets = JSON.parse(localStorage.getItem('budgets') || '{}');
let funds = JSON.parse(localStorage.getItem('sinkingFunds') || '[]');
let debts = JSON.parse(localStorage.getItem('debts') || '[]');
let subs = JSON.parse(localStorage.getItem('subs') || '[]');
let wallets = JSON.parse(localStorage.getItem('wallets')) || [{id:1, name:'Tunai', icon:'ğŸ’µ', initial:0}];
let userProfile = JSON.parse(localStorage.getItem('userProfile')) || { name: 'Bos', joined: new Date().toLocaleDateString() };

// --- ANALYTICS LOGIC ---
function setAnalyticsMode(mode) {
    document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(mode === 'month' ? 'modeMonth' : 'modeRange').classList.add('active');
    
    if (mode === 'month') {
        document.getElementById('filterMonthArea').style.display = 'block';
        document.getElementById('filterRangeArea').style.display = 'none';
        
        const mSel = document.getElementById('anaMonth');
        const ySel = document.getElementById('anaYear');
        const months = translations[currentLang].months_arr;
        mSel.innerHTML = months.map((m,i) => `<option value="${i}">${m}</option>`).join('');
        
        if (ySel.options.length === 0) {
            const cy = new Date().getFullYear();
            for(let i=cy-2; i<=cy+1; i++) ySel.innerHTML += `<option value="${i}">${i}</option>`;
            mSel.value = new Date().getMonth();
            ySel.value = cy;
        }
    } else {
        document.getElementById('filterMonthArea').style.display = 'none';
        document.getElementById('filterRangeArea').style.display = 'block';
    }
}

function calculateAnalytics() {
    const isMonth = document.getElementById('modeMonth').classList.contains('active');
    let startDate, endDate;

    if (isMonth) {
        const m = parseInt(document.getElementById('anaMonth').value);
        const y = parseInt(document.getElementById('anaYear').value);
        startDate = new Date(y, m, 1);
        endDate = new Date(y, m + 1, 0);
    } else {
        const s = document.getElementById('anaStart').value;
        const e = document.getElementById('anaEnd').value;
        if(!s || !e) return showToast("Pilih tanggal!", "error");
        startDate = new Date(s);
        endDate = new Date(e);
    }

    const filtered = transactions.filter(t => {
        const d = new Date(t.date);
        return d >= startDate && d <= endDate;
    });

    const report = { income: 0, expense: 0, details: {} };

    filtered.forEach(t => {
        if(t.cat === 'Transfer') return;
        
        if (t.type === 'income') report.income += t.amount;
        else report.expense += t.amount;

        const typeKey = t.type; 
        if (!report.details[typeKey]) report.details[typeKey] = {};
        if (!report.details[typeKey][t.cat]) report.details[typeKey][t.cat] = { total: 0, subs: {} };
        
        report.details[typeKey][t.cat].total += t.amount;
        
        const subName = t.sub || 'Lainnya';
        if (!report.details[typeKey][t.cat].subs[subName]) report.details[typeKey][t.cat].subs[subName] = 0;
        report.details[typeKey][t.cat].subs[subName] += t.amount;
    });

    const container = document.getElementById('analyticsResult');
    
    let html = `
    <div class="grid-2" style="margin-bottom:20px; margin-top:20px">
        <div class="card" style="padding:15px; text-align:center; border-bottom:4px solid var(--secondary)">
            <div class="text-sm">Total Masuk</div>
            <div class="text-xl" style="color:var(--secondary)">${fmtMoney(report.income)}</div>
        </div>
        <div class="card" style="padding:15px; text-align:center; border-bottom:4px solid var(--danger)">
            <div class="text-sm">Total Keluar</div>
            <div class="text-xl" style="color:var(--danger)">${fmtMoney(report.expense)}</div>
        </div>
    </div>
    `;

    const renderSection = (type, title, color) => {
        if (!report.details[type]) return '';
        let sectionHtml = `<h4 style="margin:15px 0 10px 0; color:${color}">${title}</h4>`;
        
        Object.keys(report.details[type]).forEach(cat => {
            const data = report.details[type][cat];
            const subList = Object.keys(data.subs).map(sub => `
                <div class="sub-row">
                    <span>${sub}</span>
                    <span>${fmtMoney(data.subs[sub])}</span>
                </div>
            `).join('');

            sectionHtml += `
            <div class="detail-item">
                <div class="detail-header" onclick="this.nextElementSibling.classList.toggle('open')">
                    <span>${cat}</span>
                    <b>${fmtMoney(data.total)}</b>
                </div>
                <div class="detail-sub">
                    ${subList}
                </div>
            </div>`;
        });
        return sectionHtml;
    };

    html += `<div class="card">`;
    html += renderSection('income', 'ğŸ’° Pemasukan', 'var(--secondary)');
    html += '<hr style="border:0; border-top:1px dashed var(--border); margin:15px 0">';
    html += renderSection('expense', 'ğŸ’¸ Pengeluaran', 'var(--danger)');
    html += `</div>`;

    container.innerHTML = html;
}
setAnalyticsMode('month');

// --- AVATAR LOGIC ---
function handleAvatarFile(input) {
    const file = input.files[0];
    if (file) {
        if(file.size > 500 * 1024) return alert("File max 500KB");
        const reader = new FileReader();
        reader.onload = function(e) {
            userProfile.avatar = e.target.result;
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            updateProfileUI();
            showToast("Avatar Updated!");
        };
        reader.readAsDataURL(file);
    }
}
function updateProfileUI() {
    document.getElementById('profileNameDisplay').innerText = userProfile.name || 'User';
    document.getElementById('inputProfileName').value = userProfile.name || '';
    const av = document.getElementById('profileAvatar');
    const imgSrc = userProfile.avatar || null;
    if (imgSrc) { av.innerHTML = `<img src="${imgSrc}" alt="avatar">`; } 
    else { av.innerHTML = `<svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>`; }
}

function getWalletBalance(wid) {
    const w = wallets.find(x => x.id === wid); if(!w) return 0;
    const trans = transactions.filter(t => t.walletId === wid || (!t.walletId && wid === wallets[0].id));
    const inc = trans.filter(t => t.type === 'income').reduce((a,b)=>a+b.amount,0);
    const exp = trans.filter(t => t.type === 'expense').reduce((a,b)=>a+b.amount,0);
    return w.initial + inc - exp;
}

function getEmergencyFundData() {
    const wajibCats = ['Kebutuhan'];
    const expWajib = transactions.filter(t => t.type === 'expense' && wajibCats.includes(t.cat));
    const months = {};
    expWajib.forEach(t => { const m = t.date.slice(0, 7); months[m] = (months[m] || 0) + t.amount; });
    const monthKeys = Object.keys(months);
    const totalExp = Object.values(months).reduce((a, b) => a + b, 0);
    const avgMonthlyExp = monthKeys.length ? totalExp / monthKeys.length : 0;
    const emergencyFund = transactions.filter(t => t.cat === 'Tabungan' && t.sub === 'Dana Darurat').reduce((sum, t) => sum + (t.type === 'income' ? t.amount : -t.amount), 0);
    const targetMonths = 6;
    const idealFund = avgMonthlyExp * targetMonths;
    const progress = idealFund > 0 ? (emergencyFund / idealFund) * 100 : 0;
    const runway = avgMonthlyExp > 0 ? (emergencyFund / avgMonthlyExp) : 0;
    return { avgMonthlyExp, emergencyFund, idealFund, progress, targetMonths, runway };
}

function init() {
    loadTheme();
    document.getElementById('langSelect').value = appConfig.lang;
    document.getElementById('currencySymbol').value = appConfig.curSymbol;
    document.getElementById('currencyLocale').value = appConfig.curLocale;
    document.getElementById('tSub').innerHTML = `<option value="">-</option>`;
    document.getElementById('bSub').innerHTML = `<option value="">-</option>`;
    updateDOMText();
    document.getElementById('tDate').valueAsDate = new Date();
    document.getElementById('bMonth').value = new Date().toISOString().slice(0, 7);
    populateChartFilters(); 
    refreshCats(); refreshWalletsDropdown(); renderDashboard(); renderHistory();
    renderAccount(); updateProfileUI(); renderCharts();
}

function updateProfile() {
    const name = document.getElementById('inputProfileName').value;
    if(name) {
        userProfile.name = name;
        localStorage.setItem('userProfile', JSON.stringify(userProfile));
        updateProfileUI();
        showToast(t('btn_save') + "!");
    }
}
function renderAccount() { updateProfileUI(); }

// --- WALLETS LOGIC ---
function addWallet() {
    const name = document.getElementById('wName').value;
    const init = Number(document.getElementById('wInit').value);
    const icon = document.getElementById('wIcon').value;
    if(name) {
        wallets.push({id: Date.now(), name, icon, initial: init});
        localStorage.setItem('wallets', JSON.stringify(wallets));
        renderWallets(); refreshWalletsDropdown(); renderDashboard();
        document.getElementById('wName').value=''; document.getElementById('wInit').value='';
        showToast("Success!");
    }
}
function deleteWallet(id) {
    if(wallets.length <= 1) return alert("Minimal 1 wallet!");
    if(confirm('Delete?')) {
        wallets = wallets.filter(w => w.id !== id);
        localStorage.setItem('wallets', JSON.stringify(wallets));
        renderWallets(); refreshWalletsDropdown(); renderDashboard();
    }
}
function renderWallets() {
    document.getElementById('walletsList').innerHTML = wallets.map(w => {
        const bal = getWalletBalance(w.id);
        return `<div class="card" style="padding:15px; border-left: 5px solid var(--primary)">
            <div class="flex-between"><b>${w.icon} ${w.name}</b> <button onclick="deleteWallet(${w.id})" class="btn-danger btn-sm">Ã—</button></div>
            <div class="text-sm" style="margin-top:5px; opacity:0.7">${t('balance_txt')}</div>
            <div class="text-xl" style="color:var(--text-main)">${fmtMoney(bal)}</div>
        </div>`;
    }).join('');
}
function refreshWalletsDropdown() {
    const opts = wallets.map(w => `<option value="${w.id}">${w.icon} ${w.name}</option>`).join('');
    ['tWallet', 'editWallet', 'nabungSourceWallet', 'nabungTargetWallet', 'emgSourceWallet', 'emgTargetWallet', 'dWallet'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.innerHTML = opts;
    });
    refreshTransferDropdowns();
}

function refreshTransferDropdowns() {
    const opts = wallets.map(w => `<option value="${w.id}">${w.icon} ${w.name}</option>`).join('');
    ['trfSource', 'trfTarget'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.innerHTML = opts;
    });
}

function processTransfer() {
    const s = Number(document.getElementById('trfSource').value);
    const t = Number(document.getElementById('trfTarget').value);
    const a = Number(document.getElementById('trfAmount').value);
    if(s === t) return showToast("Dompet sama!", "error");
    if(!a || a <= 0) return showToast("Nominal salah!", "error");

    const wT = wallets.find(w => w.id === t); const wS = wallets.find(w => w.id === s);

    transactions.push({ id: Date.now(), date: new Date().toISOString().split('T')[0], type: 'expense', cat: 'Transfer', sub: 'Keluar', amount: a, note: `Transfer ke ${wT.name}`, walletId: s });
    setTimeout(() => {
        transactions.push({ id: Date.now() + 1, date: new Date().toISOString().split('T')[0], type: 'income', cat: 'Transfer', sub: 'Masuk', amount: a, note: `Terima dari ${wS.name}`, walletId: t });
        saveData(); renderDashboard(); renderHistory(); renderWallets();
        showToast(t('trans_success'));
        document.getElementById('trfAmount').value = '';
    }, 50);
}

function addTransaction() {
    const amt = Number(document.getElementById('tAmount').value);
    const wid = Number(document.getElementById('tWallet').value);
    const t = { id: Date.now(), date: document.getElementById('tDate').value, type: document.getElementById('tType').value, cat: document.getElementById('tCat').value, sub: document.getElementById('tSub').value, amount: amt, note: document.getElementById('tNote').value, walletId: wid };
    if(!t.date || !t.amount || !t.cat) return showToast(t('data_incomplete'), "error");
    transactions.push(t); saveData(); renderDashboard(); renderHistory();
    document.getElementById('tAmount').value = ''; showToast("Saved!");
}
function deleteTrans(id) { if(confirm('Hapus?')) { transactions = transactions.filter(t => t.id !== id); saveData(); renderDashboard(); renderHistory(); } }

function renderDashboard() {
    const total = wallets.reduce((acc, w) => acc + getWalletBalance(w.id), 0);
    document.getElementById('saldoDisplay').innerText = fmtMoney(total);
    const now = new Date(); const currM = now.toISOString().slice(0,7);
    const inc = transactions.filter(t=>t.type==='income' && t.date.startsWith(currM) && t.cat !== 'Transfer').reduce((a,b)=>a+b.amount,0);
    const exp = transactions.filter(t=>t.type==='expense' && t.date.startsWith(currM) && t.cat !== 'Transfer').reduce((a,b)=>a+b.amount,0);
    document.getElementById('incDisplay').innerText = fmtMoney(inc); 
    document.getElementById('expDisplay').innerText = fmtMoney(exp);
    const efData = getEmergencyFundData();
    document.getElementById('runwayDisplay').innerText = efData.runway.toFixed(1) + " " + t('month');
    document.getElementById('avgExpDisplay').innerText = t('avg_txt') + ": " + fmtMoney(efData.avgMonthlyExp);
    updateMascot(total, efData.runway); renderFunds(); renderFinancialAnalysis(efData); renderBudgetList(); renderCharts();
}

function renderFinancialAnalysis(ef) {
    let status = t('status_risk'); let color = "var(--danger)";
    if (ef.progress >= 100) { status = t('status_ideal'); color = "#0ea5e9"; } 
    else if (ef.progress >= 70) { status = t('status_safe'); color = "var(--secondary)"; } 
    else if (ef.progress >= 30) { status = t('status_ok'); color = "var(--warning)"; }
    document.getElementById('analysisContainer').innerHTML = `<div class="analysis-row"><span>${t('avg_monthly')}</span><b>${fmtMoney(ef.avgMonthlyExp)}</b></div><div class="analysis-row"><span>${t('current_ef')}</span><b>${fmtMoney(ef.emergencyFund)}</b></div><div class="analysis-row"><span>${t('target')} (${ef.targetMonths} ${t('month')})</span><b>${fmtMoney(ef.idealFund)}</b></div><div class="analysis-row"><span>${t('progress')}</span><b style="color:${color}">${ef.progress.toFixed(1)}%</b></div><div style="margin-top:10px; background:#eee; border-radius:10px; overflow:hidden;"><div style="height:12px; width:${Math.min(100, ef.progress)}%; background:${color};"></div></div><div class="analysis-row"><span>${t('status')}</span><b style="color:${color}">${status}</b></div>`;
}

// --- BUG FIX: OPEN EDIT MODAL ---
function openEditModal(id) {
    // FIX: rename var to 'trans' to avoid conflict with translation function t()
    const trans = transactions.find(x => x.id === id); 
    if (!trans) return;
    
    const ec = document.getElementById('editCat');
    ec.innerHTML = `<option value="">${t('opt_select')}</option>`; 
    Object.keys(categories).forEach(c=>ec.innerHTML+=`<option value="${c}">${c}</option>`);
    
    document.getElementById('editId').value = trans.id;
    document.getElementById('editDate').value = trans.date;
    document.getElementById('editType').value = trans.type;
    document.getElementById('editWallet').value = trans.walletId || wallets[0].id;
    document.getElementById('editAmount').value = trans.amount;
    document.getElementById('editCat').value = trans.cat;
    
    updateSub('editCat', 'editSub');
    document.getElementById('editSub').value = trans.sub;
    document.getElementById('editNote').value = trans.note;

    document.getElementById('editModal').classList.add('active');
}
function closeEditModal() { document.getElementById('editModal').classList.remove('active'); }
function saveEditTransaction() {
    const id = Number(document.getElementById('editId').value);
    const tIndex = transactions.findIndex(x => x.id === id);
    if (tIndex === -1) return;
    transactions[tIndex] = {
        id: id,
        date: document.getElementById('editDate').value,
        type: document.getElementById('editType').value,
        walletId: Number(document.getElementById('editWallet').value),
        amount: Number(document.getElementById('editAmount').value),
        cat: document.getElementById('editCat').value,
        sub: document.getElementById('editSub').value,
        note: document.getElementById('editNote').value
    };
    saveData(); closeEditModal(); renderDashboard(); renderHistory(); showToast("Updated!");
}

// --- PDF DOWNLOAD ---
function downloadPDF() {
    const { jsPDF } = window.jspdf; const doc = new jsPDF();
    let d = transactions.sort((a,b)=>new Date(b.date)-new Date(a.date));
    doc.setFontSize(18); doc.text("Laporan Keuangan", 14, 22);
    doc.setFontSize(11); doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 30);
    const tableData = d.map(t => [ t.date, t.cat, t.sub, t.note, (t.type === 'income' ? '+' : '-') + fmtMoney(t.amount) ]);
    doc.autoTable({ startY: 35, head: [['Tanggal', 'Kategori', 'Sub', 'Catatan', 'Nominal']], body: tableData });
    doc.save(`Laporan_KeuanganKu_${new Date().toISOString().slice(0,10)}.pdf`);
}

function renderHistory() {
    const key = document.getElementById('searchKeyword').value.toLowerCase();
    const type = document.getElementById('searchType').value;
    const start = document.getElementById('searchDateStart').value;
    const end = document.getElementById('searchDateEnd').value;
    let d = transactions.sort((a,b)=>new Date(b.date)-new Date(a.date));
    if(key) d = d.filter(t => (t.note && t.note.toLowerCase().includes(key)) || t.cat.toLowerCase().includes(key));
    if(type !== 'all') d = d.filter(t => t.type === type);
    if(start) d = d.filter(t => t.date >= start);
    if(end) d = d.filter(t => t.date <= end);
    document.querySelector('#historyTable tbody').innerHTML = d.slice(0, 50).map(t => {
        const w = wallets.find(x => x.id === t.walletId) || wallets[0];
        return `<tr><td class="text-sm">${t.date}</td><td><b>${t.cat}</b><br><small class="text-sm">${t.sub||''} (${w.name})</small><div style="font-size:0.8rem; opacity:0.7">${t.note||''}</div></td><td style="font-weight:bold; color:${t.type==='income'?'var(--secondary)':'var(--danger)'}">${t.type==='income'?'+':'-'} ${fmtMoney(t.amount)}</td><td><div style="display:flex; gap:5px;"><button onclick="openEditModal(${t.id})" class="btn-sm btn-outline" title="Edit">âœï¸</button><button onclick="deleteTrans(${t.id})" class="btn-danger btn-sm" title="Hapus">Ã—</button></div></td></tr>`
    }).join('');
}

// --- DEBTS, SUBS, FUNDS (UPDATED) ---
// Fix: Add Debt now includes transaction recording with Wallet
function addDebt() { 
    const name = document.getElementById('dName').value; 
    const amount = Number(document.getElementById('dAmount').value); 
    const type = document.getElementById('dType').value;
    const wid = Number(document.getElementById('dWallet').value);
    
    if(!name || !amount || !wid) return showToast(t('data_incomplete'), "error");
    
    // 1. Create Debt Entry
    const newDebt = { id: Date.now(), name, amount, type, paid: false, date: new Date().toISOString().slice(0,10), walletId: wid };
    debts.push(newDebt);
    
    // 2. Create Transaction (Cash Flow)
    // Receivable (Piutang) = Money Out (Expense), Payable (Hutang) = Money In (Income)
    transactions.push({
        id: Date.now() + 1,
        date: newDebt.date,
        type: type === 'receivable' ? 'expense' : 'income',
        cat: 'Hutang/Piutang',
        sub: type === 'receivable' ? 'Piutang' : 'Hutang',
        amount: amount,
        note: (type === 'receivable' ? 'Pinjamkan ke ' : 'Pinjam dari ') + name,
        walletId: wid
    });

    saveData(); 
    localStorage.setItem('debts', JSON.stringify(debts)); 
    renderDebts(); renderDashboard(); renderHistory();
    showToast(t('debt_saved'));
}

// Fix: Settle Debt now asks for Wallet via Prompt
function settleDebt(id) { 
    const d = debts.find(x => x.id === id); 
    if(d && !d.paid) {
        // Build prompt string
        const wList = wallets.map((w, i) => `${i+1}. ${w.name}`).join('\n');
        const input = prompt(t('settle_prompt') + "\n" + wList, "1");
        
        if (input) {
            const wIndex = parseInt(input) - 1;
            if (wallets[wIndex]) {
                const selectedWallet = wallets[wIndex];
                
                // Record Transaction
                // Pay Debt (Payable) = Expense, Receive Debt (Receivable) = Income
                transactions.push({ 
                    id:Date.now(), 
                    date:new Date().toISOString().split('T')[0], 
                    type: d.type==='receivable' ? 'income' : 'expense', 
                    cat:'Hutang/Piutang', 
                    sub: d.type==='receivable' ? 'Terima Piutang' : 'Bayar Hutang', 
                    amount: d.amount, 
                    note:`Lunas: ${d.name}`, 
                    walletId: selectedWallet.id 
                }); 
                
                d.paid = true; 
                saveData(); 
                localStorage.setItem('debts', JSON.stringify(debts)); 
                renderDebts(); renderDashboard(); renderHistory();
                showToast(t('settle_saved'));
            } else {
                alert(t('wallet_invalid'));
            }
        }
    } 
}

function deleteDebt(id) { if(confirm('Delete?')) { debts=debts.filter(x=>x.id!==id); localStorage.setItem('debts', JSON.stringify(debts)); renderDebts(); } }

function renderDebts() { 
    const rec = debts.filter(d=>d.type==='receivable'&&!d.paid).reduce((a,b)=>a+b.amount,0); 
    const pay = debts.filter(d=>d.type==='payable'&&!d.paid).reduce((a,b)=>a+b.amount,0); 
    document.getElementById('totalReceivable').innerText = fmtMoney(rec); 
    document.getElementById('totalPayable').innerText = fmtMoney(pay); 
    document.getElementById('debtsList').innerHTML = debts.sort((a,b)=>a.paid-b.paid).map(d => `
        <div class="card" style="padding:15px; border:2px solid ${d.paid?'#dfe6e9':(d.type==='receivable'?'var(--secondary)':'var(--danger)')}; opacity:${d.paid?0.6:1}">
            <div class="flex-between"><b>${d.name}</b> <span class="badge" style="background:${d.paid?'#b2bec3':(d.type==='receivable'?'var(--secondary)':'var(--danger)')}; color:white">${d.paid?t('status_paid'):(d.type==='receivable'?t('short_receivable'):t('short_payable'))}</span></div>
            <div class="text-xl" style="margin:5px 0">${fmtMoney(d.amount)}</div>
            <div class="text-sm">${d.date}</div>
            <div style="margin-top:10px; display:flex; gap:5px">
                ${!d.paid ? `<button onclick="settleDebt(${d.id})" class="btn-sm btn-outline">${t('mark_paid')}</button>` : `<button disabled class="btn-sm btn-outline">${t('mark_ok')}</button>`}
                <button onclick="deleteDebt(${d.id})" class="btn-sm btn-danger">ğŸ—‘ï¸</button>
            </div>
        </div>`).join(''); 
}

function addSub() { const n = document.getElementById('sName').value; const a = Number(document.getElementById('sAmount').value); if(n&&a) { subs.push({id:Date.now(), name:n, amount:a, cycle:document.getElementById('sCycle').value}); localStorage.setItem('subs',JSON.stringify(subs)); renderSubs(); }}

// Fix: Pay Sub now reads from dropdown
function paySub(id) { 
    const s = subs.find(x=>x.id===id); 
    const wid = Number(document.getElementById(`subWallet-${id}`).value);
    
    if(s && confirm(t('pay_confirm') + ` ${s.name}?`)) { 
        transactions.push({
            id:Date.now(), 
            date:new Date().toISOString().split('T')[0], 
            type:'expense', 
            cat:'Kebutuhan', 
            sub:'Langganan', 
            amount:s.amount, 
            note:s.name, 
            walletId: wid
        }); 
        saveData(); showToast("Terbayar!"); renderDashboard(); renderHistory();
    }
}

function deleteSub(id) { if(confirm('Delete?')) { subs=subs.filter(x=>x.id!==id); localStorage.setItem('subs',JSON.stringify(subs)); renderSubs(); }}

// Fix: Render Subs includes Wallet Dropdown
function renderSubs() { 
    const wOpts = wallets.map(w => `<option value="${w.id}">${w.icon} ${w.name}</option>`).join('');
    document.getElementById('subsList').innerHTML = subs.map(s => `
        <div class="card" style="padding:15px; text-align:center">
            <b>${s.name}</b>
            <div class="text-xl" style="color:var(--primary)">${fmtMoney(s.amount)}</div>
            <div class="text-sm">/${s.cycle==='1'?'Mo':'Yr'}</div>
            <select id="subWallet-${s.id}" style="margin-top:5px; font-size:0.8rem">${wOpts}</select>
            <button onclick="paySub(${s.id})" class="btn-success btn-block" style="margin-top:5px">${t('pay_btn')}</button>
            <button onclick="deleteSub(${s.id})" class="btn-danger btn-block" style="margin-top:5px">${t('del_btn')}</button>
        </div>`).join(''); 
}

function toggleFundForm() { document.getElementById('fundForm').style.display = document.getElementById('fundForm').style.display==='none'?'block':'none'; }
function addFund() { const n=document.getElementById('fundName').value; const t=Number(document.getElementById('fundTarget').value); if(n&&t){ funds.push({id:Date.now(), name:n, target:t, current:0}); localStorage.setItem('sinkingFunds',JSON.stringify(funds)); renderFunds(); toggleFundForm(); }}
function deleteFund(id) { if(confirm('Hapus?')) { funds=funds.filter(x=>x.id!==id); localStorage.setItem('sinkingFunds',JSON.stringify(funds)); renderFunds(); }}

// --- CHARTS & FILTERS ---
function populateChartFilters() {
    const mSel = document.getElementById('filterMonth'); const ySel = document.getElementById('filterYear');
    const months = translations[currentLang].months_arr;
    const now = new Date();
    mSel.innerHTML = ""; ySel.innerHTML = "";
    mSel.innerHTML = months.map((m,i) => `<option value="${i}" ${i===now.getMonth()?'selected':''}>${m}</option>`).join('');
    const cy = now.getFullYear();
    for(let i=cy-2; i<=cy+1; i++) { ySel.innerHTML += `<option value="${i}" ${i===cy?'selected':''}>${i}</option>`; }
}
let charts = {};
function renderCharts() {
    const mVal = parseInt(document.getElementById('filterMonth').value);
    const yVal = parseInt(document.getElementById('filterYear').value);
    const getData = (filterFn) => { const d={}; transactions.filter(t=>t.type==='expense' && t.cat !== 'Transfer' && filterFn(t)).forEach(t=>d[t.cat]=(d[t.cat]||0)+t.amount); return d; };
    const pieConfig = (d) => ({
        type: 'doughnut', data: { labels: Object.keys(d), datasets:[{ data:Object.values(d), backgroundColor:['#6366f1','#ec4899','#10b981','#f59e0b','#3b82f6', '#8b5cf6'], borderWidth:0 }] },
        options: { responsive:true, maintainAspectRatio:false, cutout:'60%', plugins:{ legend:{display:false}, datalabels: { color: '#fff', font: { weight: 'bold', size: 10 }, formatter: (value, ctx) => { let sum = 0; ctx.chart.data.datasets[0].data.map(data => sum += data); return (value*100 / sum).toFixed(0)+"%"; } } } }
    });
    const dMonthly = getData(t => { const d = new Date(t.date); return d.getMonth() === mVal && d.getFullYear() === yVal; });
    if(charts['monthly']) charts['monthly'].destroy(); charts['monthly'] = new Chart(document.getElementById('chartMonthly'), pieConfig(dMonthly));
    const dYearly = getData(t => { const d = new Date(t.date); return d.getFullYear() === yVal; });
    if(charts['yearly']) charts['yearly'].destroy(); charts['yearly'] = new Chart(document.getElementById('chartYearly'), pieConfig(dYearly));
    const ctxA = document.getElementById('chartAnnual'); 
    const labels=['J','F','M','A','M','J','J','A','S','O','N','D'];
    const iD=Array(12).fill(0), eD=Array(12).fill(0);
    transactions.forEach(t=>{ const d=new Date(t.date); if(d.getFullYear()===yVal && t.cat !== 'Transfer'){ if(t.type==='income') iD[d.getMonth()]+=t.amount; else eD[d.getMonth()]+=t.amount; } });
    if(charts['annual']) charts['annual'].destroy(); 
    charts['annual'] = new Chart(ctxA, { type:'bar', data:{labels:labels, datasets:[{label: t('income'), data:iD, backgroundColor:'#10b981', borderRadius:5}, {label: t('expense'), data:eD, backgroundColor:'#ff6b6b', borderRadius:5}]}, options:{responsive:true, maintainAspectRatio:false, scales:{x:{grid:{display:false}},y:{grid:{display:false}}}, plugins:{legend:{display:false}, datalabels:{display:false}}} });
}

function renderBudgetList() {
    const list = document.getElementById('budgetList'); const bM = document.getElementById('bMonth').value; const bd = budgets[bM]||{}; 
    const sp = {}; transactions.filter(t=>t.type==='expense'&&t.date.startsWith(bM)).forEach(t=>sp[t.sub]=(sp[t.sub]||0)+t.amount);
    if (Object.keys(bd).length === 0) { list.innerHTML = '<small style="opacity:0.6">No budgets.</small>'; return; }
    list.innerHTML = Object.keys(bd).map(k => {
        const used = sp[k]||0; const limit = bd[k]; const pct = Math.round(used/limit*100);
        return `<div style="margin-bottom:12px; border-bottom:1px solid #eee; padding-bottom:8px;"><div class="flex-between"><small><b>${k}</b></small> <div style="display:flex; gap:5px"><button onclick="editBudget('${bM}', '${k}')" class="btn-sm btn-outline" style="padding:2px 6px; font-size:0.7rem">âœï¸</button><button onclick="deleteBudget('${bM}', '${k}')" class="btn-sm btn-danger" style="padding:2px 6px; font-size:0.7rem">ğŸ—‘ï¸</button></div></div><div class="flex-between" style="margin-top:2px;"><small class="text-muted">${pct}%</small><small class="text-muted">${fmtMoney(used)} / ${fmtMoney(limit)}</small></div><div style="background:#eee; height:6px; border-radius:3px; margin-top:2px"><div style="width:${Math.min(100,pct)}%; height:100%; background:${pct>100?'var(--danger)':'var(--secondary)'}; border-radius:3px"></div></div></div>`;
    }).join('');
}
function deleteBudget(month, subCat) { if(confirm(`Delete ${subCat}?`)) { delete budgets[month][subCat]; localStorage.setItem('budgets', JSON.stringify(budgets)); renderBudgetList(); } }
function editBudget(month, subCat) { const oldVal = budgets[month][subCat]; const newVal = prompt(`Limit ${subCat}:`, oldVal); if(newVal && !isNaN(newVal)) { budgets[month][subCat] = Number(newVal); localStorage.setItem('budgets', JSON.stringify(budgets)); renderBudgetList(); } }

function renderFunds() { 
    document.getElementById('fundsList').innerHTML = funds.map(f => { 
        const pct = Math.min(100, Math.round(f.current/f.target*100)); 
        return `<div class="card" style="padding:15px; border:2px solid #0ea5e9;"><div class="flex-between"><b>${f.name}</b> <small>${pct}%</small></div><div style="background:#eee; height:8px; border-radius:4px; margin:5px 0"><div style="width:${pct}%; height:100%; background:#0ea5e9; border-radius:4px;"></div></div><div class="text-sm">${fmtMoney(f.current)} / ${fmtMoney(f.target)}</div><div style="margin-top:10px; display:flex; gap:5px"><button onclick="openNabungModal(${f.id})" class="btn-sm btn-success" style="flex:1">${t('modal_nabung')}</button><button onclick="deleteFund(${f.id})" class="btn-sm btn-danger">Ã—</button></div></div>`; 
    }).join(''); 
    document.getElementById('totalFundsDisplay').innerText = fmtMoney(funds.reduce((a,b)=>a+b.current,0)); 
}
function openNabungModal(id) {
    const f = funds.find(x => x.id === id); if(!f) return;
    document.getElementById('nabungFundId').value = id;
    document.getElementById('nabungTitle').innerText = `Target: ${f.name}`;
    document.getElementById('nabungAmount').value = '';
    refreshWalletsDropdown(); document.getElementById('nabungModal').classList.add('active');
}
function processNabung() {
    const id = Number(document.getElementById('nabungFundId').value);
    const amount = Number(document.getElementById('nabungAmount').value);
    const sourceWalletId = Number(document.getElementById('nabungSourceWallet').value);
    const targetWalletId = Number(document.getElementById('nabungTargetWallet').value); 
    if (!amount || amount <= 0) return showToast("Nominal tidak valid!", "error");
    if (!sourceWalletId) return showToast("Pilih dompet sumber!", "error");
    if (!targetWalletId) return showToast("Pilih dompet tujuan!", "error");
    const currentBal = getWalletBalance(sourceWalletId);
    if (currentBal < amount) return showToast("Saldo dompet sumber kurang!", "error");
    const fund = funds.find(x => x.id === id);
    const wTarget = wallets.find(w => w.id === targetWalletId);
    fund.current += amount;
    transactions.push({ id: Date.now(), date: new Date().toISOString().split('T')[0], type: 'expense', cat: 'Transfer', sub: 'Keluar', amount: amount, note: `Pindah ke tabungan: ${fund.name}`, walletId: sourceWalletId });
    setTimeout(() => {
        transactions.push({ id: Date.now() + 10, date: new Date().toISOString().split('T')[0], type: 'income', cat: 'Tabungan', sub: fund.name, amount: amount, note: `Setoran: ${fund.name}`, walletId: targetWalletId });
        localStorage.setItem('sinkingFunds', JSON.stringify(funds)); saveData(); 
        document.getElementById('nabungModal').classList.remove('active');
        renderFunds(); renderDashboard(); renderHistory();
        showToast(`Berhasil ditabung ke ${wTarget.name}!`);
    }, 50);
}

function openEmergencyModal() { document.getElementById('emergencyModal').classList.add('active'); refreshWalletsDropdown(); }
function processEmergencyFund() {
    const amt = Number(document.getElementById('emgAmount').value);
    const srcW = Number(document.getElementById('emgSourceWallet').value);
    const tgtW = Number(document.getElementById('emgTargetWallet').value);
    if(amt <= 0 || !srcW || !tgtW) return showToast("Data tidak lengkap", "error");
    transactions.push({ id: Date.now(), date: new Date().toISOString().split('T')[0], type: 'expense', cat: 'Transfer', sub: 'Keluar', amount: amt, note: 'Isi Dana Darurat', walletId: srcW });
    setTimeout(() => {
        transactions.push({ id: Date.now() + 1, date: new Date().toISOString().split('T')[0], type: 'income', cat: 'Tabungan', sub: 'Dana Darurat', amount: amt, note: 'Setoran Dana Darurat', walletId: tgtW });
        saveData(); renderDashboard(); document.getElementById('emergencyModal').classList.remove('active'); showToast("Dana Darurat Terisi!");
    }, 50);
}

function refreshCats() { 
    ['tCat','bCat','parentCatSelect','delCatSelect', 'editCat', 'delSubParent'].forEach(id=>{ 
        const el=document.getElementById(id); 
        if(el){ 
            el.innerHTML=`<option value="">${t('opt_select')}</option>`; 
            Object.keys(categories).forEach(c=>el.innerHTML+=`<option value="${c}">${c}</option>`); 
        }
    }); 
}

function updateSub(c,s) { 
    const v=document.getElementById(c).value; const el=document.getElementById(s); 
    el.innerHTML = "";
    if(categories[v] && categories[v].length > 0) {
        categories[v].forEach(i => { el.innerHTML += `<option value="${i}">${i}</option>`; });
    } else { el.innerHTML = `<option value="">-</option>`; }
}

function addNewCategory() { const n=document.getElementById('newCatName').value; if(n&&!categories[n]){categories[n]=[]; localStorage.setItem('myCategories',JSON.stringify(categories)); refreshCats(); showToast("Success!");} }
function addNewSubCategory() { const p=document.getElementById('parentCatSelect').value; const s=document.getElementById('newSubName').value; if(p&&s){categories[p].push(s); localStorage.setItem('myCategories',JSON.stringify(categories)); showToast("Success!");} }
function deleteCategory() { const n=document.getElementById('delCatSelect').value; if(n && confirm('Delete?')) { delete categories[n]; localStorage.setItem('myCategories',JSON.stringify(categories)); refreshCats(); showToast("Deleted!"); } }
function deleteSubCategory() { 
    const p = document.getElementById('delSubParent').value; const s = document.getElementById('delSubSelect').value;
    if(p && s && confirm(`Hapus ${s}?`)) {
        categories[p] = categories[p].filter(item => item !== s);
        localStorage.setItem('myCategories', JSON.stringify(categories)); refreshCats(); updateSub('delSubParent', 'delSubSelect'); showToast("Sub Deleted!");
    }
}
function setBudget() { const m=document.getElementById('bMonth').value; const s=document.getElementById('bSub').value; const a=Number(document.getElementById('bAmount').value); if(m&&s&&a) { if(!budgets[m]) budgets[m]={}; budgets[m][s]=a; localStorage.setItem('budgets',JSON.stringify(budgets)); renderDashboard(); showToast("Set!"); } }
function saveData() { localStorage.setItem('transactions', JSON.stringify(transactions)); }
function backupData() { const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify({transactions,categories,budgets,funds,debts,subs,wallets,userProfile,appConfig,version:'7.3'})],{type:'application/json'})); a.download=`KeuanganKu_Fixed_${new Date().toISOString().slice(0,10)}.json`; a.click(); }
function restoreData(input) { const r=new FileReader(); r.onload=e=>{ try{ const d=JSON.parse(e.target.result); if(confirm("Overwrite data?")){ if(d.transactions)localStorage.setItem('transactions',JSON.stringify(d.transactions)); if(d.categories)localStorage.setItem('myCategories',JSON.stringify(d.categories)); if(d.wallets)localStorage.setItem('wallets',JSON.stringify(d.wallets)); if(d.userProfile)localStorage.setItem('userProfile',JSON.stringify(d.userProfile)); if(d.appConfig)localStorage.setItem('appConfig',JSON.stringify(d.appConfig)); location.reload(); } }catch(e){alert("File Error");} }; if(input.files[0]) r.readAsText(input.files[0]); }
function downloadExcel() { const ws=XLSX.utils.json_to_sheet(transactions); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Data"); XLSX.writeFile(wb,"KeuanganKu.xlsx"); }

document.getElementById('bMonth').addEventListener('change', renderDashboard);
init();
</script>
</body>
</html>
